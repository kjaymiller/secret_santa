{% extends "base.html" %}

{% block title %}{{ event.name }} - Secret Santa{% endblock %}

{% block content %}
    <div class="mb-10">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-3xl font-bold text-forest mb-2">
                    {{ event.name }}
                </h1>
                <div class="flex gap-3 items-center">
                    <span class="badge {% if event.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                        {% if event.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                    {% if event.assignments_revealed_at %}
                        <span class="badge badge-gold">
                            Assignments Generated
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="flex gap-2">
                <a href="{% url 'events:event-update' event.pk %}" class="btn btn-secondary">Edit Event</a>
                <a href="{% url 'events:event-delete' event.pk %}" class="btn btn-secondary btn-danger">Delete</a>
            </div>
        </div>

        <div class="grid-cols-2 mb-8">
            <div class="card">
                <h2 class="text-xl font-semibold text-charcoal mb-4">Event Details</h2>

                {% if event.description %}
                    <div class="mb-5">
                        <strong class="text-gray text-sm">Description:</strong>
                        <p class="text-charcoal mt-1">{{ event.description }}</p>
                    </div>
                {% endif %}

                <div class="grid gap-3">
                    <div>
                        <strong class="text-gray text-sm">Exchange Date:</strong>
                        <p class="text-charcoal">{{ event.exchange_date|date:"l, F d, Y" }}</p>
                    </div>

                    {% if event.budget_limit %}
                        <div>
                            <strong class="text-gray text-sm">Budget Limit:</strong>
                            <p class="text-charcoal">${{ event.budget_limit }}</p>
                        </div>
                    {% endif %}

                    <div>
                        <strong class="text-gray text-sm">Created:</strong>
                        <p class="text-charcoal">{{ event.created_at|date:"M d, Y" }}</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-5">
                <div class="card">
                    <h2 class="text-xl font-semibold text-charcoal mb-4">Invite Link</h2>

                    <p class="text-gray text-sm mb-3">
                        Share this code or link with participants:
                    </p>

                    <div class="invite-code-box">
                        <strong class="block text-xs text-gray mb-1">
                            Invite Code:
                        </strong>
                        <code class="invite-code">
                            {{ event.invite_code }}
                        </code>
                    </div>

                    <div class="bg-cream p-3 rounded break-all">
                        <a href="{% url 'events:join-event' event.invite_code %}" class="text-forest text-sm">
                            {{ request.scheme }}://{{ request.get_host }}{% url 'events:join-event' event.invite_code %}
                        </a>
                    </div>
                </div>

                {% if invite_form %}
                    <div class="card">
                        <h2 class="text-xl font-semibold text-charcoal mb-4">Send Invites</h2>
                        <p class="text-gray text-sm mb-3">
                            Enter email addresses to send invites directly.
                        </p>
                        <form method="post" action="{% url 'events:event-send-invites' event.pk %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                {{ invite_form.emails }}
                                {% if invite_form.emails.help_text %}
                                    <p class="text-xs text-gray mt-1">{{ invite_form.emails.help_text }}</p>
                                {% endif %}
                                {% for error in invite_form.emails.errors %}
                                    <p class="text-xs text-red mt-1">{{ error }}</p>
                                {% endfor %}
                            </div>
                            <button type="submit" class="btn w-full">Send Invites</button>
                        </form>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card mb-5">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-semibold text-charcoal">
                    Participants ({{ participants.count }})
                </h2>
            </div>

            {% if participants %}
                <div class="grid gap-3">
                    {% for participant in participants %}
                        <div class="participant-row">
                            <div>
                                <div>
                                    <strong class="text-charcoal">{{ participant.name }}</strong>
                                    <span class="text-gray text-sm ml-2">
                                        {{ participant.email }}
                                    </span>
                                    {% if participant.is_confirmed %}
                                        <span class="badge badge-active ml-2 text-xs">
                                            Confirmed
                                        </span>
                                    {% else %}
                                        <span class="badge badge-inactive ml-2 text-xs">
                                            Pending
                                        </span>
                                    {% endif %}
                                </div>
                                {% if participant.exclusions.exists %}
                                    <div class="mt-1 text-gray text-xs">
                                        <em>Excludes: {% for excluded in participant.exclusions.all|slice:":3" %}{{ excluded.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if participant.exclusions.count > 3 %} and {{ participant.exclusions.count|add:"-3" }} more{% endif %}</em>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="flex gap-2">
                                <a href="{% url 'events:participant-detail' participant.pk %}" class="btn btn-secondary text-sm py-1 px-3">
                                    View
                                </a>
                                <a href="{% url 'events:participant-remove' participant.pk %}" class="btn btn-secondary btn-danger text-sm py-1 px-3">
                                    Remove
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                {% include "includes/empty_state.html" with icon="ðŸ‘¥" title="No participants yet" description="Share the invite code or link to get people to join your Secret Santa event!" %}
            {% endif %}
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold text-charcoal mb-4">
                Assignments
            </h2>

            {% if event.assignments_revealed_at %}
                <div class="mb-4">
                    <p class="text-forest mb-3">
                        Assignments were generated on {{ event.assignments_revealed_at|date:"M d, Y \a\t g:i A" }}
                    </p>
                    <a href="{% url 'events:assignment-status' event.pk %}" class="btn">
                        View Assignment Status
                    </a>
                </div>
            {% else %}
                {% if can_generate_assignments %}
                    <p class="text-gray mb-4">
                        You have {{ confirmed_participants.count }} confirmed participants. Ready to generate assignments!
                    </p>
                    <form method="post" action="{% url 'events:assignment-generate' event.pk %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="btn" onclick="return confirm('Are you sure? This cannot be undone!');">
                            Generate Assignments
                        </button>
                    </form>
                {% else %}
                    <p class="text-gray">
                        You need at least 3 confirmed participants to generate assignments.
                        Currently: {{ confirmed_participants.count }} confirmed.
                    </p>
                {% endif %}
            {% endif %}
        </div>

        <div class="mt-5 flex gap-3 flex-wrap">
            <a href="{% url 'events:notification-list' event.pk %}" class="btn btn-secondary">
                Manage Notifications
            </a>
            {% if confirmed_participants.count > 0 %}
                <a href="{% url 'events:exclusion-group-list' event.pk %}" class="btn btn-secondary">
                    Exclusion Groups
                </a>
                <a href="{% url 'events:exclusion-manage' event.pk %}" class="btn btn-secondary">
                    Individual Exclusions
                </a>
            {% endif %}
        </div>
    </div>
{% endblock content %}
